---
title: "Nginxã«gzipã‚ˆã‚Šæ€§èƒ½ã®è‰¯ã•ãã†ãªBrotliåœ§ç¸®ã‚’å°å…¥ã—ã¦ã¿ãŸ"
emoji: "ğŸš„"
type: "tech"
topics:
  - "nginx"
  - "brotli"
published: true
published_at: "2024-11-21 12:49"
---

# æ¦‚è¦

- Nginxã§ä»Šã¾ã§ãƒ‡ãƒ¼ã‚¿ã‚’gzipåœ§ç¸®å½¢å¼ã§é…ä¿¡ã—ã¦ã„ãŸã€‚
- **Brotli**ã¨ã„ã†é«˜é€Ÿåœ§ç¸®è¡“ã‚’ç”¨ã„ãŸåœ§ç¸®ãŒã‚ã£ãŸã®ã§ãã‚Œã‚’è¨­å®šã—ã¦ã¿ãŸã€‚

# Brotliã¨ã¯

**Brotliã¯ã€Webã‚µã‚¤ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¸®å°ã™ã‚‹ãŸã‚ã«GoogleãŒé–‹ç™ºã—ãŸã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®åœ§ç¸®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚Gzipã¨æ¯”è¼ƒã—ã¦ã€å¹³å‡20ï¼…é«˜ã„åœ§ç¸®ç‡ã‚’èª‡ã‚Šã€å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ï»¿**

Brotliã¯ã€HTMLã‚„JavaScriptã§é »å‡ºã•ã‚Œã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒå«ã¾ã‚Œã‚‹é™çš„è¾æ›¸ã‚’ç”¨ã„ã¦åœ§ç¸®ã—ã¦ã„ã¾ã™ã€‚
åœ§ç¸®ãƒ¬ãƒ™ãƒ«ã¯0ã‹ã‚‰11ã¾ã§12æ®µéšãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æ•°å­—ãŒå¤§ãããªã‚‹ã»ã©åœ§ç¸®ç‡ãŒé«˜ããªã‚Šã¾ã™ã€‚
ãŸã ã—ã€åœ§ç¸®ç‡ãŒé«˜ããªã‚‹ã»ã©ã‚ˆã‚Šå¤šãã®è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã™ã‚‹ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚„CDNå´ã®è² è·ãŒé«˜ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ï»¿

- Brotliã¯Gzipã«æ¯”ã¹ã¦15%ã»ã©åœ§ç¸®ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
- Brotliã¯Gzipã¨æ¯”è¼ƒã—ã¦ã€åŒã˜é€Ÿåº¦ã§ã‚ˆã‚Šå°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã«åœ§ç¸®ã—ã€åŒã˜é€Ÿåº¦ã§è§£å‡ã—ã¾ã™ã€‚
- å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã‘ã‚Œã°å¤§ãã„ã»ã©Brotliã®åŠ¹æœãŒé«˜ãã§ã¦ã„ã¾ã™ã€‚
- Brotliã‚’ãƒ¬ãƒ™ãƒ«11ã§åœ§ç¸®ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æœ€é«˜ã®Gzipåœ§ç¸®ãƒ¬ãƒ™ãƒ«ã¨æ¯”è¼ƒã—ã¦19%å°ã•ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- gzipã¯ã»ã¨ã‚“ã©ã®å ´åˆBrotliã«é€Ÿåº¦ã§å‹ã‚‹ã‚‚ã®ã®ã€åœ§ç¸®ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã£ã¦çµæœãŒç•°ãªã‚Šã¾ã™ã€‚ï»¿

# å°å…¥æ–¹æ³•

## DockerFile

```DockerFile
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®š
FROM ubuntu:22.04 as builder

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt update && apt install -y \
    libpcre3 libpcre3-dev zlib1g zlib1g-dev openssl libssl-dev wget git gcc make libbrotli-dev \
    && rm -rf /var/lib/apt/lists/*

# Nginxã¨ngx_brotliãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ“ãƒ«ãƒ‰
WORKDIR /app
RUN wget https://nginx.org/download/nginx-1.25.3.tar.gz \
    && tar -zxf nginx-1.25.3.tar.gz \
    && git clone --recurse-submodules https://github.com/google/ngx_brotli \
    && cd nginx-1.25.3 \
    && ./configure --with-compat --add-dynamic-module=../ngx_brotli \
    && make modules

# Nginxã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
FROM nginx:1.25.3

# ãƒ“ãƒ«ãƒ‰ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/nginx-1.25.3/objs/ngx_http_brotli_static_module.so /etc/nginx/modules/
COPY --from=builder /app/nginx-1.25.3/objs/ngx_http_brotli_filter_module.so /etc/nginx/modules/

# Brotliã®è¨­å®šã‚’è¿½åŠ 
RUN { \
    echo 'brotli on;'; \
    echo 'brotli_comp_level 6;'; \
    echo 'brotli_static on;'; \
    echo 'brotli_types application/atom+xml application/javascript application/json application/rss+xml'; \
    echo '          application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype'; \
    echo '          application/x-font-ttf application/x-javascript application/xhtml+xml application/xml'; \
    echo '          font/eot font/opentype font/otf font/truetype image/svg+xml image/vnd.microsoft.icon'; \
    echo '          image/x-icon image/x-win-bitmap text/css text/javascript text/plain text/xml;'; \
    } > /etc/nginx/conf.d/brotli.conf
```

**1.  æº–å‚™**
   - å¿…è¦ãªä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: Brotliåœ§ç¸®ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€Nginxã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å‰ã«ã€**libbrotli-dev**ã‚’å«ã‚€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
RUN apt update && apt install -y \
    libpcre3 libpcre3-dev zlib1g zlib1g-dev openssl libssl-dev wget git gcc make libbrotli-dev \
    && rm -rf /var/lib/apt/lists/*
```

**2.  Nginxã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**
   - Nginxã®å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã¾ãŸã¯å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```sh
RUN wget https://nginx.org/download/nginx-1.25.3.tar.gz \
    && tar -zxf nginx-1.25.3.tar.gz \
```

**3.  ngx_brotliãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¯ãƒ­ãƒ¼ãƒ³**
   - Brotliåœ§ç¸®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹**ngx_brotl**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€Brotliåœ§ç¸®ã¨å±•é–‹ã®ä¸¡æ–¹ã‚’Nginxã§å®Ÿç¾ã—ã¾ã™ã€‚

```sh
 git clone --recurse-submodules https://github.com/google/ngx_brotli \
```

**4. ãƒ“ãƒ«ãƒ‰è¨­å®šã®å®Ÿè¡Œ**
   - Nginxã®ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€./configurã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚
ã“ã®éš›ã«ã€**--add-dynamic-module**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ngx_brotliãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```sh
cd nginx-1.25.3 \
 ./configure --with-compat --add-dynamic-module=../ngx_brotli \
```

**5. Nginxã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**
   - è¨­å®šã«åŸºã¥ãã€makã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦Nginxã¨ngx_brotlãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™**make module**ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€æŒ‡å®šã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```sh
make modules
```

## Nginx

```conf
user  nginx;
worker_processes auto;

pid        /var/run/nginx.pid;

load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

http {
       ~~ çœç•¥ ~~ 

        brotli on;
        brotli_types text/css application/javascript application/json application/font-woff application/font-tff image/gif image/png image/jpeg application/octet-stream;
    }
}
```

## å®Ÿéš›ã®æŒ™å‹•

Content-EncodingãŒbrã«ãªã£ã¦ã„ã‚‹ã€‚
é€Ÿåº¦çš„ã«ã¯ã¡ã‚‡ã£ã¨é€Ÿããªã£ã¦ã„ã‚‹ã‹ã‚‚(å¾®å¦™)

![](https://storage.googleapis.com/zenn-user-upload/57e8b9706dde-20241121.png)

# ã¾ã¨ã‚

- ã©ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæœ€å¼·ã¨ã„ã†ã‚ˆã‚Šã€ã„ãšã‚Œã‚‚ä¸€é•·ä¸€çŸ­ã‚ã‚‹ã€‚
- ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã»ã©ã€Brotliã®åŠ¹æœãŒå‡ºãã†

![](https://storage.googleapis.com/zenn-user-upload/ceacf5896bc7-20241121.png)

â€»ç”»åƒã¯ä»¥ä¸‹ã‚ˆã‚Šå¼•ç”¨

https://hidekatsu-izuno.hatenablog.com/entry/2016/07/06/003803